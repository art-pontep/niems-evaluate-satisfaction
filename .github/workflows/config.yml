# Configuration Workflow
# This workflow validates and updates configuration based on GitHub Secrets

name: Configuration Validation

on:
  # Runs when secrets are updated (via workflow_dispatch)
  workflow_dispatch:
    inputs:
      validate_only:
        description: 'Only validate secrets without deploying'
        required: false
        default: false
        type: boolean

  # Also runs on push to check configuration
  push:
    branches: ["main"]
    paths:
      - 'app.js'
      - '.github/workflows/config.yml'

jobs:
  validate-config:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Admin Password Secret
        run: |
          echo "ğŸ” Checking Admin Password Configuration..."
          
          if [ -n "${{ secrets.ADMIN_PASSWORD }}" ]; then
            # Check password length (minimum 6 characters recommended)
            PASSWORD_LENGTH=${#ADMIN_PASSWORD}
            if [ "$PASSWORD_LENGTH" -lt 6 ]; then
              echo "âš ï¸ Warning: Admin password is less than 6 characters"
            else
              echo "âœ… Admin password secret is configured"
            fi
          else
            echo "âš ï¸ Warning: ADMIN_PASSWORD secret is not set"
            echo "ğŸ“ Using default password from app.js"
            echo ""
            echo "To set a custom password:"
            echo "1. Go to Repository Settings"
            echo "2. Navigate to Secrets and variables > Actions"
            echo "3. Click 'New repository secret'"
            echo "4. Name: ADMIN_PASSWORD"
            echo "5. Value: Your secure password"
          fi
        env:
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}

      - name: Check Required Files
        run: |
          echo "ğŸ“ Checking required files..."
          
          required_files=("index.html" "styles.css" "app.js")
          missing_files=()
          
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file exists"
            else
              echo "âŒ $file is missing"
              missing_files+=("$file")
            fi
          done
          
          if [ ${#missing_files[@]} -gt 0 ]; then
            echo "::error::Missing required files: ${missing_files[*]}"
            exit 1
          fi
          
          echo ""
          echo "âœ… All required files are present"

      - name: Validate JavaScript Syntax
        run: |
          echo "ğŸ” Validating JavaScript syntax..."
          node --check app.js && echo "âœ… app.js syntax is valid" || echo "âŒ app.js has syntax errors"

      - name: Configuration Summary
        run: |
          echo ""
          echo "=================================="
          echo "ğŸ“‹ Configuration Summary"
          echo "=================================="
          echo ""
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo ""
          
          if [ -n "${{ secrets.ADMIN_PASSWORD }}" ]; then
            echo "ğŸ” Admin Password: âœ… Custom (from secret)"
          else
            echo "ğŸ” Admin Password: âš ï¸ Default (admin123)"
          fi
          
          echo ""
          echo "=================================="

  # Optional: Trigger deployment if validation passes
  trigger-deploy:
    needs: validate-config
    if: ${{ github.event.inputs.validate_only != 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Deployment
        run: |
          echo "âœ… Configuration validated successfully"
          echo "ğŸš€ Deployment will be triggered by the deploy.yml workflow"
